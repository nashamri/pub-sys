{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        .image-preview {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .preview-content {
            max-width: 90%;
            max-height: 90%;
        }
    </style>
</head>

<body class="min-h-screen bg-gray-50">
    <!-- Image Preview Modal -->
    <div id="imagePreview" class="image-preview">
        <div class="relative">
            <img id="previewImage" class="preview-content" src="" alt="Preview">
            <button onclick="closePreview()"
                class="absolute -top-4 -right-4 bg-red-500 text-white rounded-full w-8 h-8 flex items-center justify-center hover:bg-red-600">Ã—</button>
        </div>
    </div>

    <div class="bg-white p-6 rounded-lg shadow-md">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-bold">Uploaded Files</h2>
            <div class="flex space-x-2">
                <button onclick="getSelectedFiles()"
                    class="px-3 py-1 bg-gray-200 text-gray-700 rounded hover:bg-gray-300 text-sm">
                    Get Selected Files
                </button>
                <button class="px-3 py-1 bg-gray-200 text-gray-700 rounded hover:bg-gray-300 text-sm">
                    Action 2
                </button>
                <button class="px-3 py-1 bg-gray-200 text-gray-700 rounded hover:bg-gray-300 text-sm">
                    Action 3
                </button>
            </div>
        </div>

        <div class="overflow-x-auto">
            <table class="min-w-full bg-white border border-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th
                            class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b w-8">
                            <input type="checkbox" id="selectAll" class="rounded text-blue-500">
                        </th>
                        <th
                            class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b">
                            File Name</th>
                        <th
                            class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b">
                            Uploaded By</th>
                        <th
                            class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b">
                            Date Uploaded</th>
                        <th
                            class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b">
                            Actions</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-200">
                    {% if files %}
                    {% for file in files %}
                    <tr>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900 border-b">
                            <input type="checkbox" class="file-checkbox rounded text-blue-500"
                                data-file-id="{{ file.id }}">
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900 border-b">
                            {{ file.upload.name|default:"Unnamed File" }}
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500 border-b">
                            {{ file.uploaded_by.username }}
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500 border-b">
                            {{ file.uploaded_at|date:"M d, Y" }}
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500 border-b">
                            <div class="flex space-x-2">
                                <a href="{{ file.upload.url }}" download
                                    class="px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600 text-sm">
                                    Download
                                </a>
                                <button onclick="confirmDelete({{ file.id }},'{{ file.upload.name }}')"
                                    class="px-3 py-1 bg-red-500 text-white rounded hover:bg-red-600 text-sm">
                                    Delete
                                </button>
                                {% if file.upload.name|lower|slice:'-4:' in '.jpg,.png,.gif,.bmp,.jpeg' %}
                                <button onclick="previewImage('{{ file.upload.url }}')"
                                    class="px-3 py-1 bg-green-500 text-white rounded hover:bg-green-600 text-sm">
                                    Preview
                                </button>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                    {% else %}
                    <tr>
                        <td colspan="5" class="px-4 py-3 text-center text-sm text-gray-500">
                            No files have been uploaded yet.
                        </td>
                    </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>

    <script>
        let currentFileId = null;

        var CSRF_TOKEN = '{{ csrf_token }}';

        // Image Preview Functions
        function previewImage(url) {
            document.getElementById('previewImage').src = url;
            document.getElementById('imagePreview').style.display = 'flex';
        }

        function closePreview() {
            document.getElementById('imagePreview').style.display = 'none';
        }

        // Close preview when clicking outside image
        document.getElementById('imagePreview').addEventListener('click', function (e) {
            if (e.target === this) closePreview();
        });

        // Select All functionality
        document.getElementById('selectAll').addEventListener('change', function (e) {
            const checkboxes = document.querySelectorAll('.file-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = e.target.checked;
            });
        });

        // Get selected files function
        function getSelectedFiles() {
            const selectedCheckboxes = document.querySelectorAll('.file-checkbox:checked');
            const selectedIds = Array.from(selectedCheckboxes).map(checkbox => checkbox.dataset.fileId);

            if (selectedIds.length === 0) {
                alert('No files selected!');
                return;
            }
            if (confirm(`Are you sure you want to delete ${selectedIds.length} selected file(s)?`)) {
                $.ajax({
                    url: '/admin/files/delete-selected/',
                    method: 'POST',
                    dataType: 'json',
                    contentType: 'application/json',
                    data: JSON.stringify({ file_ids: selectedIds }),
                    beforeSend: function (xhr) {
                        xhr.setRequestHeader('X-CSRFToken', csrftoken);
                    },
                    success: function (response) {
                        if (response.success) {
                            alert(response.message);
                            // Refresh the page to show updated file list
                            location.reload();
                        } else {
                            let errorMessage = response.message;
                            if (response.errors) {
                                errorMessage += '\n\nErrors:\n' + response.errors.join('\n');
                            }
                            alert(errorMessage);
                        }
                    },
                    error: function (error) {
                        console.error('Error deleting files:', error);
                        alert('Error deleting files. See console for details.');
                    }
                });
            }
        }


        // File Deletion
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        const csrftoken = getCookie('csrftoken');

        function confirmDelete(fileId, fileName) {
            console.log('aa', fileName)
            if (confirm('Are you sure you want to delete this file? ')) {
                $.ajax({
                    url: `/admin/files/${fileId}/delete/`,
                    cache: false,
                    dataType: 'json',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ "filename": fileName }),
                    beforeSend: function (xhr) {
                        xhr.setRequestHeader('X-CSRFToken', csrftoken);
                    },
                    success: function (data) {
                        console.log('File deleted successfully', data);
                    },
                    error: function (error) {
                        console.error('Error deleting file:', error);
                    }
                });
            }
        }
    </script>
</body>

</html>